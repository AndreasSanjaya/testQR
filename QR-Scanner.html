<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Scanner</title>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  </head>
  <body>
    <div id="reader" style="width: 300px; height: 300px"></div>
    <form id="qrForm" action="/submit-qr-data" method="POST">
      <input type="hidden" id="qrData" name="qrData" />
    </form>
    <script>
      function onScanSuccess(qrMessage) {
        // Handle the scanned message
        const formData = new FormData();
        formData.append("qrData", qrMessage);

        fetch("/submit-qr-data", {
          method: "POST",
          body: formData,
          headers: {
            "X-CSRF-TOKEN": document
              .querySelector('meta[name="csrf-token"]')
              .getAttribute("content"),
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              alert("QR Code data matched: " + JSON.stringify(data.data));
            } else {
              alert("QR Code data did not match.");
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      function onScanError(errorMessage) {
        // Handle the error (optional)
        console.error(errorMessage);
      }

      // Initialize the QR code scanner
      const html5QrCode = new Html5Qrcode("reader");

      html5QrCode
        .start(
          { facingMode: "environment" }, // Use rear camera
          {
            fps: 10, // Scans per second
            qrbox: { width: 250, height: 250 }, // Scanning box
          },
          onScanSuccess,
          onScanError
        )
        .catch((err) => {
          console.error(`Unable to start scanning, error: ${err}`);
        });
    </script>
  </body>
</html>
